{% extends "base.html" %}

{% block title %}Dashboard - Drowsiness Detection{% endblock %}

{% block content %}
<div class="row">
    <!-- System Status -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <span class="status-indicator" id="detection-status"></span>
                    <span id="detection-text">Detection Inactive</span>
                </div>
                
                <div class="mb-3">
                    <span class="status-indicator" id="telegram-status"></span>
                    <span id="telegram-text">Telegram Not Configured</span>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-success" id="start-btn" onclick="startDetection()">
                        <i class="fas fa-play me-2"></i>Start Detection
                    </button>
                    <button class="btn btn-danger" id="stop-btn" onclick="stopDetection()" style="display: none;">
                        <i class="fas fa-stop me-2"></i>Stop Detection
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar text-success me-2"></i>
                    Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h3 class="text-primary mb-0" id="total-alerts">0</h3>
                        <small class="text-muted">Total Alerts</small>
                    </div>
                    <div class="col-6">
                        <h3 class="text-success mb-0" id="session-alerts">0</h3>
                        <small class="text-muted">Session Alerts</small>
                    </div>
                </div>
                
                <div class="row text-center mt-2">
                    <div class="col-6">
                        <h4 class="text-info mb-0" id="blink-count">0</h4>
                        <small class="text-muted">Blinks</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning mb-0" id="yawn-count">0</h4>
                        <small class="text-muted">Yawns</small>
                    </div>
                </div>
                
                <hr>
                
                <div class="text-center">
                    <small class="text-muted">FPS:</small> <span id="current-fps" class="fw-bold">0</span><br>
                    <small class="text-muted">Last Alert:</small><br>
                    <span id="last-alert">Never</span>
                </div>
                
                <!-- More Details Collapsible Section -->
                <div class="mt-3">
                    <button class="btn btn-outline-primary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#moreDetails">
                        <i class="fas fa-chevron-down me-2"></i>More Details
                    </button>
                    
                    <div class="collapse mt-2" id="moreDetails">
                        <div class="card card-body bg-light">
                            <div class="row text-center">
                                <div class="col-4">
                                    <h4 class="text-info mb-0" id="live-blinks">0</h4>
                                    <small class="text-muted">Live Blinks</small>
                                </div>
                                <div class="col-4">
                                    <h4 class="text-warning mb-0" id="live-yawns">0</h4>
                                    <small class="text-muted">Live Yawns</small>
                                </div>
                                <div class="col-4">
                                    <h4 class="text-danger mb-0" id="continuous-sleep">0.0s</h4>
                                    <small class="text-muted">Continuous Sleep</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Current Location -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-map-marker-alt text-danger me-2"></i>
                    Current Location
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <i class="fas fa-location-dot fa-2x text-danger mb-2"></i>
                    <p class="mb-2" id="location-address">Fetching location...</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="openMaps()">
                        <i class="fas fa-external-link-alt me-1"></i>
                        View on Maps
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Video Feed and Map Row -->
<div class="row">
    <!-- Video Feed -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-video text-primary me-2"></i>
                    Live Video Feed
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="video-container" style="height: 400px;">
                    <img id="video-feed" src="" alt="Video feed will appear here" 
                         style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    
                    <div id="video-placeholder" class="d-flex align-items-center justify-content-center h-100 text-muted">
                        <div class="text-center">
                            <i class="fas fa-video-slash fa-3x mb-3"></i>
                            <p>Click "Start Detection" to begin video monitoring</p>
                        </div>
                    </div>
                    
                    <div class="video-overlay" id="video-status" style="display: none;">
                        <i class="fas fa-circle text-success me-1"></i>
                        Live
                    </div>
                    
                    <div class="drowsy-alert" id="drowsy-overlay" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        DROWSINESS DETECTED!
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Google Maps -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-map text-success me-2"></i>
                    Location Map
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="map" style="height: 400px; border-radius: 0 0 15px 15px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Alerts -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell text-warning me-2"></i>
                    Recent Alerts
                </h5>
            </div>
            <div class="card-body">
                <div id="alerts-container">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-bell-slash fa-2x mb-2"></i>
                        <p>No alerts yet. System will display drowsiness alerts here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize Socket.IO
    const socket = io();
    let map;
    let marker;
    let currentLocation = {lat: 0, lng: 0};
    
    // Map initialization is now handled by the script above
    
    // Update system status
    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                // Detection status
                const detectionStatus = document.getElementById('detection-status');
                const detectionText = document.getElementById('detection-text');
                const startBtn = document.getElementById('start-btn');
                const stopBtn = document.getElementById('stop-btn');
                
                if (data.detection_active) {
                    detectionStatus.className = 'status-indicator status-active';
                    detectionText.textContent = 'Detection Active';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'block';
                } else {
                    detectionStatus.className = 'status-indicator status-inactive';
                    detectionText.textContent = 'Detection Inactive';
                    startBtn.style.display = 'block';
                    stopBtn.style.display = 'none';
                }
                
                // Telegram status
                const telegramStatus = document.getElementById('telegram-status');
                const telegramText = document.getElementById('telegram-text');
                
                if (data.telegram_configured) {
                    telegramStatus.className = 'status-indicator status-active';
                    telegramText.textContent = 'Telegram Configured';
                } else {
                    telegramStatus.className = 'status-indicator status-inactive';
                    telegramText.textContent = 'Telegram Not Configured';
                }
                
                // Statistics
                document.getElementById('total-alerts').textContent = data.stats.total_alerts;
                document.getElementById('session-alerts').textContent = data.stats.session_alerts;
                document.getElementById('blink-count').textContent = data.stats.blink_count;
                document.getElementById('yawn-count').textContent = data.stats.yawn_count;
                document.getElementById('current-fps').textContent = data.stats.fps;
                document.getElementById('last-alert').textContent = 
                    data.stats.last_alert ? new Date(data.stats.last_alert).toLocaleString() : 'Never';
                
                // Update live metrics in more details
                document.getElementById('live-blinks').textContent = data.stats.blink_count;
                document.getElementById('live-yawns').textContent = data.stats.yawn_count;
                document.getElementById('continuous-sleep').textContent = data.stats.avg_ear + 's';
                
                // Location
                if (data.location && data.location.lat !== 0) {
                    currentLocation = {lat: data.location.lat, lng: data.location.lng};
                    document.getElementById('location-address').textContent = data.location.address;
                    
                    // Update map with new position
                    updateMapPosition(data.location.lat, data.location.lng);
                }
            })
            .catch(error => console.error('Error fetching status:', error));
    }
    
    // Start detection
    function startDetection() {
        fetch('/api/start_detection', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus();
                } else {
                    alert('Failed to start detection. Please check camera connection.');
                }
            });
    }
    
    // Stop detection
    function stopDetection() {
        fetch('/api/stop_detection', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                updateStatus();
                document.getElementById('video-feed').style.display = 'none';
                document.getElementById('video-placeholder').style.display = 'flex';
                document.getElementById('video-status').style.display = 'none';
            });
    }
    
    // Open Google Maps
    function openMaps() {
        if (currentLocation.lat !== 0) {
            const url = `https://www.google.com/maps?q=${currentLocation.lat},${currentLocation.lng}`;
            window.open(url, '_blank');
        }
    }
    
    // Helper function to format duration
    function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hours > 0) {
            return `${hours}h ${minutes}m ${secs}s`;
        } else if (minutes > 0) {
            return `${minutes}m ${secs}s`;
        } else {
            return `${secs}s`;
        }
    }
    
    // Socket.IO event handlers
    socket.on('video_frame', function(data) {
        const videoFeed = document.getElementById('video-feed');
        const placeholder = document.getElementById('video-placeholder');
        const status = document.getElementById('video-status');
        const drowsyOverlay = document.getElementById('drowsy-overlay');
        
        videoFeed.src = 'data:image/jpeg;base64,' + data.frame;
        videoFeed.style.display = 'block';
        placeholder.style.display = 'none';
        status.style.display = 'block';
        
        // Update status with FPS
        status.innerHTML = `<i class="fas fa-circle text-success me-1"></i>Live (${data.fps || 0} FPS)`;
        
        // Show drowsy overlay if detected
        if (data.drowsy) {
            drowsyOverlay.style.display = 'block';
            drowsyOverlay.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                DROWSINESS DETECTED!<br>
                <small>Sleep Time: ${data.continuous_sleep || 0}s</small>
            `;
        } else {
            drowsyOverlay.style.display = 'none';
        }
        
        // Update live counters in more details
        if (document.getElementById('live-blinks')) {
            document.getElementById('continuous-sleep').textContent = (data.continuous_sleep || 0) + 's';
        }
        
        // Show blink/yawn indicators
        if (data.blink_detected) {
            showNotification('👁️ Blink detected', 'info', 1000);
        }
        
        if (data.yawn_detected) {
            showNotification('🥱 Yawn detected', 'warning', 2000);
        }
    });
    
    socket.on('drowsiness_alert', function(data) {
        // Add alert to the alerts container
        addAlert(data);
        
        // Update statistics
        updateStatus();
        
        // Show notification
        if (Notification.permission === 'granted') {
            new Notification('Drowsiness Alert!', {
                body: `Microsleep detected: ${data.duration}s at ${data.location.address}`,
                icon: '/static/alert-icon.png'
            });
        }
    });
    
    // Show temporary notifications
    function showNotification(message, type = 'info', duration = 3000) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = `
            top: 20px; 
            right: 20px; 
            z-index: 9999; 
            min-width: 250px;
            animation: slideInRight 0.3s ease-out;
        `;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after duration
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, duration);
    }
    
    function addAlert(alertData) {
        const container = document.getElementById('alerts-container');
        
        // Clear placeholder if it exists
        if (container.querySelector('.text-center')) {
            container.innerHTML = '';
        }
        
        const alertElement = document.createElement('div');
        alertElement.className = 'alert alert-danger alert-dismissible fade show mb-2';
        alertElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="alert-heading mb-1">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Drowsiness Alert
                    </h6>
                    <p class="mb-1">
                        <strong>Duration:</strong> ${alertData.duration}s<br>
                        <strong>Location:</strong> ${alertData.location.address}<br>
                        <strong>Time:</strong> ${new Date(alertData.timestamp).toLocaleString()}
                    </p>
                    ${alertData.telegram_sent ? 
                        '<small class="text-success"><i class="fas fa-check me-1"></i>Telegram alert sent</small>' : 
                        '<small class="text-warning"><i class="fas fa-exclamation me-1"></i>Telegram alert failed</small>'
                    }
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        container.insertBefore(alertElement, container.firstChild);
        
        // Keep only last 10 alerts
        const alerts = container.querySelectorAll('.alert');
        if (alerts.length > 10) {
            alerts[alerts.length - 1].remove();
        }
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize map
        initMap();
        
        updateStatus();
        setInterval(updateStatus, 5000); // Update every 5 seconds
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    });
</script>

<!-- Google Maps API - Using free alternative -->
<script>
    // Use OpenStreetMap with Leaflet instead of Google Maps (free alternative)
    function initMap() {
        // Initialize with Leaflet (OpenStreetMap)
        map = L.map('map').setView([0, 0], 15);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Create marker
        marker = L.marker([0, 0]).addTo(map)
            .bindPopup('Current Location');
    }
    
    // Update map position
    function updateMapPosition(lat, lng) {
        if (map && marker) {
            const newPos = [lat, lng];
            map.setView(newPos, 15);
            marker.setLatLng(newPos);
        }
    }
</script>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}