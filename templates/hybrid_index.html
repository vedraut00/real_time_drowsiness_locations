{% extends "base.html" %}

{% block title %}Hybrid Drowsiness Detection{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-rocket me-2"></i>
                    Choose Detection Mode
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-header bg-success text-white text-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-desktop me-2"></i>
                                    PC Mode (Recommended)
                                </h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-tachometer-alt fa-3x text-success mb-2"></i>
                                    <h6 class="text-success">High Performance</h6>
                                </div>
                                <ul class="list-unstyled text-start">
                                    <li><i class="fas fa-check text-success me-2"></i>30+ FPS smooth detection</li>
                                    <li><i class="fas fa-check text-success me-2"></i>OpenCV window with live metrics</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Web dashboard for monitoring</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Sound alerts</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Best accuracy</li>
                                </ul>
                                <button class="btn btn-success btn-lg w-100" id="start-pc-mode" onclick="startPCMode()">
                                    <i class="fas fa-play me-2"></i>Start PC Mode
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-info h-100">
                            <div class="card-header bg-info text-white text-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-globe me-2"></i>
                                    Web Mode
                                </h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-browser fa-3x text-info mb-2"></i>
                                    <h6 class="text-info">Browser Based</h6>
                                </div>
                                <ul class="list-unstyled text-start">
                                    <li><i class="fas fa-check text-info me-2"></i>Everything in browser</li>
                                    <li><i class="fas fa-check text-info me-2"></i>No additional windows</li>
                                    <li><i class="fas fa-check text-info me-2"></i>Remote access friendly</li>
                                    <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Lower FPS (~10-15)</li>
                                    <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Reduced accuracy</li>
                                </ul>
                                <button class="btn btn-info btn-lg w-100" id="start-web-mode" onclick="startWebMode()">
                                    <i class="fas fa-play me-2"></i>Start Web Mode
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status and Controls -->
<div class="row">
    <!-- System Status -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <span class="status-indicator" id="detection-status"></span>
                    <span id="detection-text">Detection Inactive</span>
                </div>
                
                <div class="mb-3">
                    <span class="status-indicator" id="mode-status"></span>
                    <span id="mode-text">No Mode Selected</span>
                </div>
                
                <div class="mb-3">
                    <span class="status-indicator" id="telegram-status"></span>
                    <span id="telegram-text">Telegram Not Configured</span>
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-danger" id="stop-btn" onclick="stopDetection()" style="display: none;">
                        <i class="fas fa-stop me-2"></i>Stop Detection
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Live Statistics -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    Live Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h3 class="text-primary mb-0" id="total-alerts">0</h3>
                        <small class="text-muted">Total Alerts</small>
                    </div>
                    <div class="col-6">
                        <h3 class="text-success mb-0" id="session-alerts">0</h3>
                        <small class="text-muted">Session Alerts</small>
                    </div>
                </div>
                
                <div class="row text-center mt-3">
                    <div class="col-6">
                        <h4 class="text-info mb-0" id="blink-count">0</h4>
                        <small class="text-muted">Blinks</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning mb-0" id="yawn-count">0</h4>
                        <small class="text-muted">Yawns</small>
                    </div>
                </div>
                
                <hr>
                
                <div class="text-center">
                    <h4 class="text-danger mb-0" id="continuous-sleep">0.0s</h4>
                    <small class="text-muted">Continuous Sleep Time</small>
                </div>
                
                <div class="text-center mt-2">
                    <small class="text-muted">FPS:</small> <span id="current-fps" class="fw-bold">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Current Location -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-map-marker-alt text-danger me-2"></i>
                    Current Location
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <i class="fas fa-location-dot fa-2x text-danger mb-2"></i>
                    <p class="mb-2" id="location-address">Fetching location...</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="openMaps()">
                        <i class="fas fa-external-link-alt me-1"></i>
                        View on Maps
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PC Mode Instructions -->
<div class="row" id="pc-mode-instructions" style="display: none;">
    <div class="col-12">
        <div class="alert alert-success">
            <h5 class="alert-heading">
                <i class="fas fa-desktop me-2"></i>PC Mode Active
            </h5>
            <p class="mb-0">
                <strong>OpenCV window opened on your PC!</strong> 
                You can see live detection with metrics overlay. 
                Press 'Q' in the OpenCV window to stop detection.
                This dashboard will show live statistics from the PC detection.
            </p>
        </div>
    </div>
</div>

<!-- Web Mode Video Feed -->
<div class="row" id="web-mode-video" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-video text-primary me-2"></i>
                    Live Video Feed - Web Mode
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="video-container" style="height: 400px;">
                    <img id="video-feed" src="" alt="Video feed will appear here" 
                         style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    
                    <div id="video-placeholder" class="d-flex align-items-center justify-content-center h-100 text-muted">
                        <div class="text-center">
                            <i class="fas fa-video-slash fa-3x mb-3"></i>
                            <p>Web mode video feed will appear here</p>
                        </div>
                    </div>
                    
                    <div class="video-overlay" id="video-status" style="display: none;">
                        <i class="fas fa-circle text-success me-1"></i>
                        Live
                    </div>
                    
                    <div class="drowsy-alert" id="drowsy-overlay" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        DROWSINESS DETECTED!
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location Map and Recent Alerts -->
<div class="row mt-4">
    <!-- Google Maps -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-map text-success me-2"></i>
                    Live Location Map
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="map" style="height: 400px; border-radius: 0 0 15px 15px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Recent Alerts -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell text-warning me-2"></i>
                    Recent Alerts
                </h5>
            </div>
            <div class="card-body">
                <div id="alerts-container">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-bell-slash fa-2x mb-2"></i>
                        <p>No alerts yet. System will display drowsiness alerts here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Leaflet CSS and JS for Maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Initialize Socket.IO
    const socket = io();
    let currentLocation = {lat: 0, lng: 0};
    let currentMode = null;
    let map;
    let marker;
    
    // Initialize map
    function initMap() {
        // Initialize with Leaflet (OpenStreetMap)
        map = L.map('map').setView([0, 0], 15);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Create marker
        marker = L.marker([0, 0]).addTo(map)
            .bindPopup('Current Location');
    }
    
    // Update map position
    function updateMapPosition(lat, lng) {
        if (map && marker) {
            const newPos = [lat, lng];
            map.setView(newPos, 15);
            marker.setLatLng(newPos);
        }
    }
    
    // Update system status
    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                // Detection status
                const detectionStatus = document.getElementById('detection-status');
                const detectionText = document.getElementById('detection-text');
                const modeStatus = document.getElementById('mode-status');
                const modeText = document.getElementById('mode-text');
                
                if (data.detection_active) {
                    detectionStatus.className = 'status-indicator status-active';
                    detectionText.textContent = 'Detection Active';
                    
                    modeStatus.className = 'status-indicator status-active';
                    modeText.textContent = data.mode === 'pc' ? 'PC Mode (High Performance)' : 'Web Mode (Browser)';
                    
                    document.getElementById('stop-btn').style.display = 'block';
                    document.getElementById('start-pc-mode').style.display = 'none';
                    document.getElementById('start-web-mode').style.display = 'none';
                    
                    // Show appropriate interface
                    if (data.mode === 'pc') {
                        document.getElementById('pc-mode-instructions').style.display = 'block';
                        document.getElementById('web-mode-video').style.display = 'none';
                    } else {
                        document.getElementById('pc-mode-instructions').style.display = 'none';
                        document.getElementById('web-mode-video').style.display = 'block';
                    }
                } else {
                    detectionStatus.className = 'status-indicator status-inactive';
                    detectionText.textContent = 'Detection Inactive';
                    
                    modeStatus.className = 'status-indicator status-inactive';
                    modeText.textContent = 'No Mode Selected';
                    
                    document.getElementById('stop-btn').style.display = 'none';
                    document.getElementById('start-pc-mode').style.display = 'block';
                    document.getElementById('start-web-mode').style.display = 'block';
                    
                    document.getElementById('pc-mode-instructions').style.display = 'none';
                    document.getElementById('web-mode-video').style.display = 'none';
                }
                
                // Telegram status
                const telegramStatus = document.getElementById('telegram-status');
                const telegramText = document.getElementById('telegram-text');
                
                if (data.telegram_configured) {
                    telegramStatus.className = 'status-indicator status-active';
                    telegramText.textContent = 'Telegram Configured';
                } else {
                    telegramStatus.className = 'status-indicator status-inactive';
                    telegramText.textContent = 'Telegram Not Configured';
                }
                
                // Statistics
                document.getElementById('total-alerts').textContent = data.stats.total_alerts;
                document.getElementById('session-alerts').textContent = data.stats.session_alerts;
                document.getElementById('blink-count').textContent = data.stats.blink_count;
                document.getElementById('yawn-count').textContent = data.stats.yawn_count;
                document.getElementById('continuous-sleep').textContent = data.stats.continuous_sleep + 's';
                document.getElementById('current-fps').textContent = data.stats.fps;
                
                // Location
                if (data.location && data.location.lat !== 0) {
                    currentLocation = {lat: data.location.lat, lng: data.location.lng};
                    document.getElementById('location-address').textContent = data.location.address;
                    
                    // Update map with new position
                    updateMapPosition(data.location.lat, data.location.lng);
                }
                
                currentMode = data.mode;
            })
            .catch(error => console.error('Error fetching status:', error));
    }
    
    // Start PC mode
    function startPCMode() {
        fetch('/api/start_pc_mode', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus();
                    showNotification('🚀 PC Mode started! OpenCV window opened.', 'success');
                } else {
                    alert('Failed to start PC mode: ' + (data.error || 'Unknown error'));
                }
            });
    }
    
    // Start web mode
    function startWebMode() {
        fetch('/api/start_web_mode', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus();
                    showNotification('🌐 Web Mode started!', 'info');
                } else {
                    alert('Failed to start web mode: ' + (data.error || 'Unknown error'));
                }
            });
    }
    
    // Stop detection
    function stopDetection() {
        fetch('/api/stop_detection', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                updateStatus();
                showNotification('🛑 Detection stopped', 'warning');
            });
    }
    
    // Open Google Maps
    function openMaps() {
        if (currentLocation.lat !== 0) {
            const url = `https://www.google.com/maps?q=${currentLocation.lat},${currentLocation.lng}`;
            window.open(url, '_blank');
        }
    }
    
    // Show notifications
    function showNotification(message, type = 'info', duration = 3000) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = `
            top: 20px; 
            right: 20px; 
            z-index: 9999; 
            min-width: 300px;
        `;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, duration);
    }
    
    // Socket.IO event handlers
    socket.on('pc_mode_data', function(data) {
        // Update statistics from PC mode
        document.getElementById('continuous-sleep').textContent = data.continuous_sleep + 's';
        document.getElementById('current-fps').textContent = data.fps;
        
        // Only show drowsiness notifications (not for every blink/yawn)
        if (data.drowsy && data.continuous_sleep >= 2.0) {
            showNotification('🚨 Drowsiness detected!', 'danger', 2000);
        }
    });
    
    socket.on('web_mode_data', function(data) {
        // Update video feed for web mode
        const videoFeed = document.getElementById('video-feed');
        const placeholder = document.getElementById('video-placeholder');
        const status = document.getElementById('video-status');
        const drowsyOverlay = document.getElementById('drowsy-overlay');
        
        if (data.frame) {
            videoFeed.src = 'data:image/jpeg;base64,' + data.frame;
            videoFeed.style.display = 'block';
            placeholder.style.display = 'none';
            status.style.display = 'block';
            status.innerHTML = `<i class="fas fa-circle text-success me-1"></i>Live (${data.fps} FPS)`;
        }
        
        // Update statistics
        document.getElementById('continuous-sleep').textContent = data.continuous_sleep + 's';
        document.getElementById('current-fps').textContent = data.fps;
        
        // Show drowsy overlay
        if (data.drowsy) {
            drowsyOverlay.style.display = 'block';
            drowsyOverlay.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                DROWSINESS DETECTED!<br>
                <small>Sleep Time: ${data.continuous_sleep}s</small>
            `;
        } else {
            drowsyOverlay.style.display = 'none';
        }
        
        // Only show significant drowsiness notifications (not for every blink/yawn)
        if (data.drowsy && data.continuous_sleep >= 2.0) {
            showNotification('🚨 Drowsiness detected!', 'danger', 2000);
        }
    });
    
    socket.on('drowsiness_alert', function(data) {
        addAlert(data);
        updateStatus();
        
        // Show notification
        if (Notification.permission === 'granted') {
            new Notification('Drowsiness Alert!', {
                body: `Critical microsleep detected: ${data.duration}s at ${data.location.address}`,
                icon: '/static/alert-icon.png'
            });
        }
    });
    
    function addAlert(alertData) {
        const container = document.getElementById('alerts-container');
        
        // Clear placeholder if it exists
        if (container.querySelector('.text-center')) {
            container.innerHTML = '';
        }
        
        const alertElement = document.createElement('div');
        alertElement.className = 'alert alert-danger alert-dismissible fade show mb-2';
        alertElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="alert-heading mb-1">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Drowsiness Alert
                    </h6>
                    <p class="mb-1">
                        <strong>Duration:</strong> ${alertData.duration}s<br>
                        <strong>Location:</strong> ${alertData.location.address}<br>
                        <strong>Time:</strong> ${new Date(alertData.timestamp).toLocaleString()}
                    </p>
                    ${alertData.telegram_sent ? 
                        '<small class="text-success"><i class="fas fa-check me-1"></i>Telegram alert sent</small>' : 
                        '<small class="text-warning"><i class="fas fa-exclamation me-1"></i>Telegram alert failed</small>'
                    }
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        container.insertBefore(alertElement, container.firstChild);
        
        // Keep only last 10 alerts
        const alerts = container.querySelectorAll('.alert');
        if (alerts.length > 10) {
            alerts[alerts.length - 1].remove();
        }
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize map
        initMap();
        
        updateStatus();
        setInterval(updateStatus, 5000); // Update every 5 seconds
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    });
</script>
{% endblock %}